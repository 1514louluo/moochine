#!/usr/bin/env lua
-- -*- lua -*-
-- Copyright 2012 Appwill Inc.
-- Author : KDr2
--
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.
--
--



HELP_INFO  = [==[
Usage:
      moochine new <APP_NAME> <APP_PATH> : create a new moochine app
      moochine help                      : show this help
]==]

ENV_INFO = [==[
Set $MOOCHINE_HOME first.

`export MOOCHINE_HOME=/path/to/your/moochine`
]==]

AVAILABLE_CMD={"new","help"}

function __FILE__() return debug.getinfo(2,'S').source end

function show_help_and_exit(help)
    if string.lower(help) == 'env' then
        print(ENV_INFO)
    else
        print(HELP_INFO)
    end
    os.exit()
end

function new_app(name,path)
    local mch_home = os.getenv('MOOCHINE_HOME')
    if not mch_home then
        show_help_and_exit('env')
    end

    local tmp_path = mch_home .. '/templates/'
    os.execute('cp -r '..tmp_path..' '..path)

    local rfile = io.open(tmp_path ..'/conf/nginx.conf', 'r')
    local wfile = io.open(path ..'/conf/nginx.conf', 'w+')
    for line in rfile:lines() do
        if string.gmatch(line, '__MOOCHINE_APP_NAME_VAULE__') then
            line = string.gsub(line, '__MOOCHINE_APP_NAME_VAULE__', name)
        end
        wfile:write(line..'\n')
    end
    io.close(rfile)
    io.close(wfile)
end

if arg[1] == 'new' then
    if not arg[2] then
        show_help_and_exit('help')
    end

    local name = arg[2]
    local path = arg[3] or os.getenv('PWD')
    if path == '.' then
        path = os.getenv('PWD')
    end
    new_app(name, path)
else
    show_help_and_exit('help')
end

